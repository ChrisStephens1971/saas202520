// Tournament Platform - Prisma Schema
// Multi-tenant architecture with Row-Level Security (RLS)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USERS & AUTHENTICATION
// ============================================================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime? @map("email_verified")
  image         String?
  password      String? // For credentials provider (hashed)

  // User management fields (Sprint 9 Phase 2)
  role              String    @default("player") // admin, organizer, player
  status            String    @default("active") // active, suspended, banned, pending
  lastLoginAt       DateTime? @map("last_login_at")
  bannedAt          DateTime? @map("banned_at")
  bannedBy          String?   @map("banned_by")
  banReason         String?   @map("ban_reason")
  suspendedUntil    DateTime? @map("suspended_until")
  suspensionReason  String?   @map("suspension_reason")

  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  accounts            Account[]
  sessions            Session[]
  organizationMembers OrganizationMember[]
  activityLogs        UserActivity[]
  moderationActions   UserModerationAction[]
  performedActions    UserModerationAction[] @relation("PerformedBy")

  @@index([role])
  @@index([status])
  @@index([lastLoginAt])
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================================================
// ORGANIZATIONS (Multi-Tenant)
// ============================================================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique

  // Notification settings (Sprint 4)
  twilioAccountSid   String? @map("twilio_account_sid") // Encrypted
  twilioAuthToken    String? @map("twilio_auth_token") // Encrypted
  twilioPhoneNumber  String? @map("twilio_phone_number")
  kioskPin           String? @map("kiosk_pin") // 4-digit PIN for kiosk mode

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  members     OrganizationMember[]
  tournaments Tournament[]

  @@map("organizations")
}

model OrganizationMember {
  id     String @id @default(cuid())
  orgId  String @map("org_id")
  userId String @map("user_id")
  role   String // owner, td, scorekeeper, streamer

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([orgId, userId])
  @@index([orgId])
  @@index([userId])
  @@map("organization_members")
}

// ============================================================================
// TOURNAMENTS
// ============================================================================

model Tournament {
  id                  String   @id @default(cuid())
  orgId               String   @map("org_id") // Tenant ID
  name                String
  description         String? // Optional tournament description
  status              String // draft, registration, active, paused, completed, cancelled
  format              String // single_elimination, double_elimination, round_robin, modified_single, chip_format
  sportConfigId       String   @map("sport_config_id")
  sportConfigVersion  String   @map("sport_config_version") // Frozen at creation
  createdBy           String   @map("created_by")
  createdAt           DateTime @default(now()) @map("created_at")
  startedAt           DateTime? @map("started_at")
  completedAt         DateTime? @map("completed_at")

  // Chip Format Configuration (Sprint 4 - CHIP-001, CHIP-002, CHIP-003)
  chipConfig          Json? @map("chip_config") // { winnerChips, loserChips, qualificationRounds, finalsCount, pairingStrategy, tiebreaker }
  qualificationLocked Boolean @default(false) @map("qualification_locked") // True after finals cutoff applied

  // Relations
  organization   Organization      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  players        Player[]
  matches        Match[]
  tables         Table[]
  events         TournamentEvent[]

  @@index([orgId])
  @@index([status])
  @@index([createdAt])
  @@map("tournaments")
}

// ============================================================================
// EVENT-SOURCED AUDIT LOG (Append-Only)
// ============================================================================

model TournamentEvent {
  id           String   @id @default(cuid())
  tournamentId String   @map("tournament_id")
  kind         String // event type (tournament.created, player.registered, etc.)
  actor        String // User ID who performed the action
  device       String // Device ID for CRDT sync
  payload      Json // Event-specific data
  timestamp    DateTime @default(now())

  // Relations
  tournament Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)

  @@index([tournamentId])
  @@index([timestamp])
  @@index([kind])
  @@map("tournament_events")
}

// ============================================================================
// PLAYERS
// ============================================================================

model Player {
  id           String   @id @default(cuid())
  tournamentId String   @map("tournament_id")
  name         String
  email        String?
  phone        String?
  rating       Json? // { system: "apa" | "fargo" | "bca", value: number | string }
  status       String // registered, checked_in, active, eliminated, no_show, withdrawn
  seed         Int?
  checkedInAt  DateTime? @map("checked_in_at")
  createdAt    DateTime @default(now()) @map("created_at")

  // Chip Format Fields (Sprint 4 - CHIP-002)
  chipCount    Int      @default(0) @map("chip_count") // Current chip total
  matchesPlayed Int     @default(0) @map("matches_played") // Qualification matches completed
  chipHistory  Json?    @map("chip_history") // Array of chip awards: [{ matchId, chipsEarned, timestamp }]

  // Relations
  tournament       Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  matchesAsPlayerA Match[]    @relation("PlayerA")
  matchesAsPlayerB Match[]    @relation("PlayerB")

  @@index([tournamentId])
  @@index([status])
  @@index([chipCount]) // For chip standings queries
  @@map("players")
}

// ============================================================================
// MATCHES
// ============================================================================

model Match {
  id           String   @id @default(cuid())
  tournamentId String   @map("tournament_id")
  round        Int
  bracket      String? // winners, losers (null for non-bracket formats)
  position     Int // Position in bracket/round
  playerAId    String?  @map("player_a_id")
  playerBId    String?  @map("player_b_id")
  state        String // pending, ready, assigned, active, completed, cancelled
  winnerId     String?  @map("winner_id")
  score        Json // { playerA: number, playerB: number, raceTo?: number, games?: GameScore[] }
  tableId      String?  @map("table_id")
  startedAt    DateTime? @map("started_at")
  completedAt  DateTime? @map("completed_at")
  rev          Int      @default(0) // Optimistic locking

  // Relations
  tournament Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  playerA    Player?    @relation("PlayerA", fields: [playerAId], references: [id])
  playerB    Player?    @relation("PlayerB", fields: [playerBId], references: [id])
  table      Table?     @relation(fields: [tableId], references: [id])

  @@index([tournamentId])
  @@index([state])
  @@index([tableId])
  @@index([round])
  @@map("matches")
}

// ============================================================================
// TABLES
// ============================================================================

model Table {
  id             String   @id @default(cuid())
  tournamentId   String   @map("tournament_id")
  label          String // e.g., "Table 1", "Back Corner"
  status         String // available, in_use, blocked
  blockedUntil   DateTime? @map("blocked_until")
  currentMatchId String?  @map("current_match_id")

  // Relations
  tournament Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  matches    Match[]

  @@index([tournamentId])
  @@index([status])
  @@map("tables")
}

// ============================================================================
// SPORT CONFIGURATIONS (Versioned, Frozen per Tournament)
// ============================================================================

model SportConfig {
  id               String   @id @default(cuid())
  name             String // e.g., "Pool 8-Ball", "Pool 9-Ball"
  sport            String // pool, darts, cornhole (future)
  rules            Json // Sport-specific rules
  scoringSchema    Json     @map("scoring_schema")
  bracketTemplates Json     @map("bracket_templates")
  version          String // Semantic version
  createdAt        DateTime @default(now()) @map("created_at")

  @@unique([name, version])
  @@index([sport])
  @@map("sport_configs")
}

// ============================================================================
// SCORING SYSTEM (Sprint 3 - SCORE-001 to SCORE-007)
// ============================================================================

model ScoreUpdate {
  id           String   @id @default(cuid())
  matchId      String   @map("match_id")
  tournamentId String   @map("tournament_id")
  actor        String // User ID who entered the score
  device       String // Device ID
  action       String // increment_a, increment_b, undo
  previousScore Json   @map("previous_score") // Score snapshot before this action
  newScore     Json     @map("new_score") // Score snapshot after this action
  timestamp    DateTime @default(now())
  undone       Boolean  @default(false) // True if this action was undone

  @@index([matchId])
  @@index([tournamentId])
  @@index([timestamp])
  @@map("score_updates")
}

// ============================================================================
// PAYMENT SYSTEM (Sprint 3 - PAY-001 to PAY-008)
// ============================================================================

model StripeAccount {
  id                    String   @id @default(cuid())
  orgId                 String   @unique @map("org_id") // One Stripe account per organization
  stripeAccountId       String   @unique @map("stripe_account_id") // Stripe Connect account ID
  onboardingComplete    Boolean  @default(false) @map("onboarding_complete")
  chargesEnabled        Boolean  @default(false) @map("charges_enabled")
  payoutsEnabled        Boolean  @default(false) @map("payouts_enabled")
  detailsSubmitted      Boolean  @default(false) @map("details_submitted")
  country               String?
  currency              String?  @default("usd")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  // Relations
  payments Payment[]

  @@index([orgId])
  @@map("stripe_accounts")
}

model Payment {
  id                  String   @id @default(cuid())
  tournamentId        String   @map("tournament_id")
  playerId            String?  @map("player_id") // Optional - may be null for manual payments
  stripeAccountId     String   @map("stripe_account_id")
  stripePaymentIntent String   @unique @map("stripe_payment_intent") // Stripe PaymentIntent ID
  amount              Int // Amount in cents
  currency            String   @default("usd")
  status              String // pending, succeeded, failed, refunded, partially_refunded
  purpose             String // entry_fee, side_pot, addon
  description         String?
  refundedAmount      Int      @default(0) @map("refunded_amount") // Amount refunded in cents
  receiptUrl          String?  @map("receipt_url")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  stripeAccount StripeAccount @relation(fields: [stripeAccountId], references: [id])
  refunds       Refund[]

  @@index([tournamentId])
  @@index([playerId])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}

model Refund {
  id              String   @id @default(cuid())
  paymentId       String   @map("payment_id")
  stripeRefundId  String   @unique @map("stripe_refund_id") // Stripe Refund ID
  amount          Int // Amount refunded in cents
  reason          String // duplicate, fraudulent, requested_by_customer
  status          String // pending, succeeded, failed, cancelled
  processedBy     String   @map("processed_by") // User ID who processed the refund
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([createdAt])
  @@map("refunds")
}

model Payout {
  id              String   @id @default(cuid())
  tournamentId    String   @map("tournament_id")
  playerId        String   @map("player_id")
  placement       Int // 1st, 2nd, 3rd, etc.
  amount          Int // Payout amount in cents
  source          String // prize_pool, side_pot
  status          String // pending, paid, voided
  paidAt          DateTime? @map("paid_at")
  paidBy          String?  @map("paid_by") // User ID who marked as paid
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([tournamentId])
  @@index([playerId])
  @@index([status])
  @@map("payouts")
}

// ============================================================================
// NOTIFICATIONS (Sprint 4)
// ============================================================================

model Notification {
  id             String    @id @default(cuid())
  orgId          String    @map("org_id") // Multi-tenant: organization scope
  tournamentId   String?   @map("tournament_id") // Optional: notification context
  playerId       String?   @map("player_id") // Optional: recipient if player-specific
  type           String    // in_app, email, sms
  channel        String    // in_app, email, sms_twilio
  recipient      String    // Email address or phone number
  subject        String?   // Optional: for email notifications
  message        String    // Notification message body
  status         String    // pending, sent, failed, delivered
  sentAt         DateTime? @map("sent_at")
  deliveredAt    DateTime? @map("delivered_at")
  errorMessage   String?   @map("error_message")
  metadata       Json?     // Additional data (e.g., Twilio message SID, retry count)
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  @@index([orgId])
  @@index([tournamentId])
  @@index([playerId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@map("notifications")
}

model NotificationPreference {
  id                String    @id @default(cuid())
  playerId          String    @unique @map("player_id") // One preference per player
  smsEnabled        Boolean   @default(true) @map("sms_enabled")
  emailEnabled      Boolean   @default(true) @map("email_enabled")
  smsOptedOut       Boolean   @default(false) @map("sms_opted_out") // User sent STOP
  smsOptedOutAt     DateTime? @map("sms_opted_out_at")
  quietHoursStart   String?   @map("quiet_hours_start") // Time format: "22:00"
  quietHoursEnd     String?   @map("quiet_hours_end") // Time format: "08:00"
  timezone          String?   // e.g., "America/New_York"
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@index([playerId])
  @@index([smsOptedOut])
  @@map("notification_preferences")
}

// ============================================================================
// AUDIT LOGS (Sprint 9 - Phase 2)
// ============================================================================

model AuditLog {
  id          String   @id @default(cuid())
  orgId       String   @map("org_id") // Multi-tenant: organization scope
  userId      String   @map("user_id") // Actor who performed the action
  userName    String   @map("user_name") // Denormalized for performance
  action      String   // create, update, delete, login, logout, failed_login, ban, suspend, etc.
  resource    String   // user, tournament, match, player, settings, etc.
  resourceId  String?  @map("resource_id") // ID of affected resource (optional for some actions)
  changes     Json?    // Before/after values for updates: { before: {...}, after: {...} }
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  metadata    Json?    // Additional context (e.g., error details, request params)
  timestamp   DateTime @default(now())

  @@index([orgId])
  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([timestamp])
  @@index([orgId, timestamp]) // Composite for fast org-scoped queries
  @@map("audit_logs")
}

// ============================================================================
// SYSTEM SETTINGS (Sprint 9 - Phase 2)
// ============================================================================

model SystemSettings {
  id          String   @id @default(cuid())
  orgId       String   @unique @map("org_id") // One settings record per organization

  // General Settings
  siteName    String?  @map("site_name")
  siteDescription String? @map("site_description")
  timezone    String?  @default("America/New_York")
  language    String?  @default("en")

  // Email Settings
  smtpHost    String?  @map("smtp_host")
  smtpPort    Int?     @map("smtp_port")
  smtpUser    String?  @map("smtp_user")
  smtpPassword String? @map("smtp_password") // Encrypted
  smtpFromEmail String? @map("smtp_from_email")
  smtpFromName  String? @map("smtp_from_name")

  // Security Settings
  sessionTimeout Int?   @map("session_timeout") // Minutes
  require2FA     Boolean @default(false) @map("require_2fa")
  passwordMinLength Int? @map("password_min_length") @default(8)
  passwordRequireSpecialChar Boolean @default(true) @map("password_require_special_char")
  maxLoginAttempts Int?  @map("max_login_attempts") @default(5)
  lockoutDuration Int?   @map("lockout_duration") // Minutes

  // Feature Flags
  features    Json?    // { liveScoring: true, notifications: true, payments: false, ... }

  // Performance Settings
  cacheTTL    Int?     @map("cache_ttl") // Seconds
  rateLimit   Int?     @map("rate_limit") // Requests per minute

  // Notification Settings
  enableEmailNotifications Boolean @default(true) @map("enable_email_notifications")
  enableSmsNotifications   Boolean @default(true) @map("enable_sms_notifications")
  enablePushNotifications  Boolean @default(false) @map("enable_push_notifications")

  // Integration Settings (stored as JSON for flexibility)
  integrations Json?   // { stripe: {...}, twilio: {...}, analytics: {...} }

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([orgId])
  @@map("system_settings")
}

// ============================================================================
// USER MANAGEMENT (Sprint 9 - Phase 2)
// ============================================================================

model UserActivity {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  action      String   // login, logout, view_tournament, create_tournament, etc.
  resource    String   // tournament, player, match, settings
  resourceId  String?  @map("resource_id")
  metadata    Json?    // Additional context
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  timestamp   DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([timestamp])
  @@index([userId, timestamp]) // Composite for user activity timeline
  @@map("user_activities")
}

model UserModerationAction {
  id            String    @id @default(cuid())
  userId        String    @map("user_id") // User being moderated
  actionType    String    @map("action_type") // warn, suspend, ban, unban, unsuspend
  reason        String
  performedBy   String    @map("performed_by") // Admin user ID
  performedAt   DateTime  @default(now()) @map("performed_at")
  expiresAt     DateTime? @map("expires_at") // For temporary suspensions
  metadata      Json?     // Additional details

  // Relations
  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)
  performer User @relation("PerformedBy", fields: [performedBy], references: [id])

  @@index([userId])
  @@index([performedBy])
  @@index([actionType])
  @@index([performedAt])
  @@map("user_moderation_actions")
}
