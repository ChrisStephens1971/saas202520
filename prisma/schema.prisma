generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String               @id @default(cuid())
  name                String?
  email               String               @unique
  emailVerified       DateTime?            @map("email_verified")
  image               String?
  password            String?
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  accounts            Account[]
  analyticsEvents     AnalyticsEvent[]
  organizationMembers OrganizationMember[]
  sessions            Session[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Organization {
  id                   String                @id @default(cuid())
  name                 String
  slug                 String                @unique
  createdAt            DateTime              @default(now()) @map("created_at")
  updatedAt            DateTime              @updatedAt @map("updated_at")
  analyticsEvents      AnalyticsEvent[]
  members              OrganizationMember[]
  revenueAggregates    RevenueAggregate[]
  scheduledReports     ScheduledReport[]
  tournamentAggregates TournamentAggregate[]
  tournaments          Tournament[]
  userCohorts          UserCohort[]

  @@map("organizations")
}

model OrganizationMember {
  id           String       @id @default(cuid())
  orgId        String       @map("org_id")
  userId       String       @map("user_id")
  role         String
  createdAt    DateTime     @default(now()) @map("created_at")
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([orgId, userId])
  @@index([orgId])
  @@index([userId])
  @@map("organization_members")
}

model Tournament {
  id                 String            @id @default(cuid())
  orgId              String            @map("org_id")
  name               String
  status             String
  format             String
  sportConfigId      String            @map("sport_config_id")
  sportConfigVersion String            @map("sport_config_version")
  createdBy          String            @map("created_by")
  createdAt          DateTime          @default(now()) @map("created_at")
  startedAt          DateTime?         @map("started_at")
  completedAt        DateTime?         @map("completed_at")
  description        String?
  matches            Match[]
  players            Player[]
  tables             Table[]
  events             TournamentEvent[]
  organization       Organization      @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([status])
  @@index([createdAt])
  @@map("tournaments")
}

model TournamentEvent {
  id           String     @id @default(cuid())
  tournamentId String     @map("tournament_id")
  kind         String
  actor        String
  device       String
  payload      Json
  timestamp    DateTime   @default(now())
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)

  @@index([tournamentId])
  @@index([timestamp])
  @@index([kind])
  @@map("tournament_events")
}

model Player {
  id               String     @id @default(cuid())
  tournamentId     String     @map("tournament_id")
  name             String
  email            String?
  phone            String?
  rating           Json?
  status           String
  seed             Int?
  checkedInAt      DateTime?  @map("checked_in_at")
  createdAt        DateTime   @default(now()) @map("created_at")
  matchesAsPlayerA Match[]    @relation("PlayerA")
  matchesAsPlayerB Match[]    @relation("PlayerB")
  tournament       Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)

  @@index([tournamentId])
  @@index([status])
  @@map("players")
}

model Match {
  id           String     @id @default(cuid())
  tournamentId String     @map("tournament_id")
  round        Int
  bracket      String?
  position     Int
  playerAId    String?    @map("player_a_id")
  playerBId    String?    @map("player_b_id")
  state        String
  winnerId     String?    @map("winner_id")
  score        Json
  tableId      String?    @map("table_id")
  startedAt    DateTime?  @map("started_at")
  completedAt  DateTime?  @map("completed_at")
  rev          Int        @default(0)
  playerA      Player?    @relation("PlayerA", fields: [playerAId], references: [id])
  playerB      Player?    @relation("PlayerB", fields: [playerBId], references: [id])
  table        Table?     @relation(fields: [tableId], references: [id])
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)

  @@index([tournamentId])
  @@index([state])
  @@index([tableId])
  @@index([round])
  @@map("matches")
}

model Table {
  id             String     @id @default(cuid())
  tournamentId   String     @map("tournament_id")
  label          String
  status         String
  blockedUntil   DateTime?  @map("blocked_until")
  currentMatchId String?    @map("current_match_id")
  matches        Match[]
  tournament     Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)

  @@index([tournamentId])
  @@index([status])
  @@map("tables")
}

model SportConfig {
  id               String   @id @default(cuid())
  name             String
  sport            String
  rules            Json
  scoringSchema    Json     @map("scoring_schema")
  bracketTemplates Json     @map("bracket_templates")
  version          String
  createdAt        DateTime @default(now()) @map("created_at")

  @@unique([name, version])
  @@index([sport])
  @@map("sport_configs")
}

model AnalyticsEvent {
  id        String       @id @default(cuid())
  tenantId  String       @map("tenant_id")
  eventType String       @map("event_type") @db.VarChar(100)
  eventData Json         @map("event_data")
  userId    String?      @map("user_id")
  sessionId String?      @map("session_id") @db.VarChar(255)
  timestamp DateTime     @default(now())
  createdAt DateTime     @default(now()) @map("created_at")
  tenant    Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User?        @relation(fields: [userId], references: [id])

  @@index([tenantId, eventType])
  @@index([tenantId, timestamp(sort: Desc)])
  @@index([userId, timestamp(sort: Desc)])
  @@map("analytics_events")
}

model RevenueAggregate {
  id                  String       @id @default(cuid())
  tenantId            String       @map("tenant_id")
  periodStart         DateTime     @map("period_start") @db.Date
  periodEnd           DateTime     @map("period_end") @db.Date
  periodType          String       @map("period_type") @db.VarChar(20)
  mrr                 Decimal?     @db.Decimal(10, 2)
  arr                 Decimal?     @db.Decimal(10, 2)
  newRevenue          Decimal?     @map("new_revenue") @db.Decimal(10, 2)
  churnedRevenue      Decimal?     @map("churned_revenue") @db.Decimal(10, 2)
  expansionRevenue    Decimal?     @map("expansion_revenue") @db.Decimal(10, 2)
  totalRevenue        Decimal?     @map("total_revenue") @db.Decimal(10, 2)
  paymentCount        Int?         @map("payment_count")
  paymentSuccessCount Int?         @map("payment_success_count")
  refundCount         Int?         @map("refund_count")
  refundAmount        Decimal?     @map("refund_amount") @db.Decimal(10, 2)
  updatedAt           DateTime     @default(now()) @updatedAt @map("updated_at")
  tenant              Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, periodType, periodStart])
  @@index([tenantId, periodStart(sort: Desc)])
  @@map("revenue_aggregates")
}

model UserCohort {
  id            String       @id @default(cuid())
  tenantId      String       @map("tenant_id")
  cohortMonth   DateTime     @map("cohort_month") @db.Date
  cohortSize    Int          @map("cohort_size")
  monthNumber   Int          @map("month_number")
  retainedUsers Int          @map("retained_users")
  retentionRate Decimal      @map("retention_rate") @db.Decimal(5, 2)
  revenue       Decimal?     @db.Decimal(10, 2)
  ltv           Decimal?     @db.Decimal(10, 2)
  updatedAt     DateTime     @default(now()) @updatedAt @map("updated_at")
  tenant        Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, cohortMonth, monthNumber])
  @@index([tenantId, cohortMonth(sort: Desc)])
  @@map("user_cohorts")
}

model TournamentAggregate {
  id                 String       @id @default(cuid())
  tenantId           String       @map("tenant_id")
  periodStart        DateTime     @map("period_start") @db.Date
  periodEnd          DateTime     @map("period_end") @db.Date
  periodType         String       @map("period_type") @db.VarChar(20)
  tournamentCount    Int?         @map("tournament_count")
  completedCount     Int?         @map("completed_count")
  completionRate     Decimal?     @map("completion_rate") @db.Decimal(5, 2)
  totalPlayers       Int?         @map("total_players")
  avgPlayers         Decimal?     @map("avg_players") @db.Decimal(10, 2)
  avgDurationMinutes Decimal?     @map("avg_duration_minutes") @db.Decimal(10, 2)
  mostPopularFormat  String?      @map("most_popular_format") @db.VarChar(100)
  revenue            Decimal?     @db.Decimal(10, 2)
  updatedAt          DateTime     @default(now()) @updatedAt @map("updated_at")
  tenant             Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, periodType, periodStart])
  @@index([tenantId, periodStart(sort: Desc)])
  @@map("tournament_aggregates")
}

model ScheduledReport {
  id         String       @id @default(cuid())
  tenantId   String       @map("tenant_id")
  name       String       @db.VarChar(255)
  reportType String       @map("report_type") @db.VarChar(50)
  frequency  String       @db.VarChar(20)
  recipients String[]
  parameters Json?
  lastRunAt  DateTime?    @map("last_run_at")
  nextRunAt  DateTime     @map("next_run_at")
  isActive   Boolean      @default(true) @map("is_active")
  createdAt  DateTime     @default(now()) @map("created_at")
  updatedAt  DateTime     @default(now()) @updatedAt @map("updated_at")
  tenant     Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([nextRunAt], map: "idx_scheduled_reports_next_run")
  @@map("scheduled_reports")
}

/// *
///  * Extended player profile information
///  * Provides rich player profiles with bio, photos, social links, and preferences
model PlayerProfile {
  id                      String   @id @default(cuid())
  playerId                String   @unique @map("player_id")
  tenantId                String   @map("tenant_id")
  bio                     String?
  photoUrl                String?  @map("photo_url") @db.VarChar(500)
  location                String?  @db.VarChar(255)
  skillLevel              String   @default("BEGINNER") @map("skill_level") @db.VarChar(50)
  privacySettings         Json     @default("{}") @map("privacy_settings")
  notificationPreferences Json     @default("{}") @map("notification_preferences")
  socialLinks             Json?    @map("social_links")
  customFields            Json?    @map("custom_fields")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([tenantId, skillLevel])
  @@index([playerId])
  @@map("player_profiles")
}

/// *
///  * Aggregated player statistics across all tournaments
///  * Pre-computed metrics for fast profile loading
model PlayerStatistics {
  id               String    @id @default(cuid())
  playerId         String    @unique @map("player_id")
  tenantId         String    @map("tenant_id")
  totalTournaments Int       @default(0) @map("total_tournaments")
  totalMatches     Int       @default(0) @map("total_matches")
  totalWins        Int       @default(0) @map("total_wins")
  totalLosses      Int       @default(0) @map("total_losses")
  winRate          Decimal   @default(0) @map("win_rate") @db.Decimal(5, 2)
  currentStreak    Int       @default(0) @map("current_streak")
  longestStreak    Int       @default(0) @map("longest_streak")
  averageFinish    Decimal?  @map("average_finish") @db.Decimal(6, 2)
  favoriteFormat   String?   @map("favorite_format") @db.VarChar(100)
  totalPrizeWon    Decimal   @default(0) @map("total_prize_won") @db.Decimal(10, 2)
  lastPlayedAt     DateTime? @map("last_played_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  @@index([tenantId, playerId])
  @@index([tenantId, winRate(sort: Desc)])
  @@index([tenantId, totalTournaments(sort: Desc)])
  @@index([tenantId, totalPrizeWon(sort: Desc)])
  @@map("player_statistics")
}

/// *
///  * System-wide achievement definitions
///  * Defines all possible achievements players can unlock
model AchievementDefinition {
  id           String   @id @default(cuid())
  code         String   @unique @db.VarChar(100)
  name         String   @db.VarChar(255)
  description  String
  iconUrl      String?  @map("icon_url") @db.VarChar(500)
  badgeUrl     String?  @map("badge_url") @db.VarChar(500)
  category     String   @db.VarChar(50)
  tier         String   @db.VarChar(50)
  requirements Json     @map("requirements")
  points       Int      @default(0)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([category])
  @@index([tier])
  @@index([isActive])
  @@map("achievement_definitions")
}

/// *
///  * Tracks unlocked achievements for each player
///  * Records when and how achievements were earned
model PlayerAchievement {
  id            String   @id @default(cuid())
  playerId      String   @map("player_id")
  tenantId      String   @map("tenant_id")
  achievementId String   @map("achievement_id")
  unlockedAt    DateTime @default(now()) @map("unlocked_at")
  progress      Int      @default(100) @map("progress")
  metadata      Json?
  createdAt     DateTime @default(now()) @map("created_at")

  @@unique([playerId, achievementId])
  @@index([tenantId, playerId])
  @@index([tenantId, achievementId])
  @@index([unlockedAt(sort: Desc)])
  @@map("player_achievements")
}

/// *
///  * Complete match history for each player
///  * Tracks every match played with detailed statistics
model MatchHistory {
  id                String   @id @default(cuid())
  matchId           String   @map("match_id")
  playerId          String   @map("player_id")
  tenantId          String   @map("tenant_id")
  tournamentId      String   @map("tournament_id")
  opponentId        String   @map("opponent_id")
  result            String   @db.VarChar(20)
  score             Json     @map("score")
  matchNumber       Int      @map("match_number")
  roundNumber       Int      @map("round_number")
  durationMinutes   Int?     @map("duration_minutes")
  skillRatingBefore Decimal? @map("skill_rating_before") @db.Decimal(10, 2)
  skillRatingAfter  Decimal? @map("skill_rating_after") @db.Decimal(10, 2)
  playedAt          DateTime @map("played_at")
  createdAt         DateTime @default(now()) @map("created_at")

  @@index([tenantId, playerId, playedAt(sort: Desc)])
  @@index([tenantId, playerId, opponentId])
  @@index([tenantId, tournamentId, playerId])
  @@index([matchId])
  @@map("match_history")
}

/// *
///  * Aggregated head-to-head records between two players
///  * Pre-computed for fast rivalry tracking
model HeadToHeadRecord {
  id            String   @id @default(cuid())
  tenantId      String   @map("tenant_id")
  player1Id     String   @map("player1_id")
  player2Id     String   @map("player2_id")
  player1Wins   Int      @default(0) @map("player1_wins")
  player2Wins   Int      @default(0) @map("player2_wins")
  draws         Int      @default(0) @map("draws")
  totalMatches  Int      @default(0) @map("total_matches")
  lastPlayedAt  DateTime @map("last_played_at")
  favorsPlayer1 Boolean  @default(true) @map("favors_player1")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, player1Id, player2Id])
  @@index([tenantId, player1Id])
  @@index([tenantId, player2Id])
  @@index([tenantId, lastPlayedAt(sort: Desc)])
  @@map("head_to_head_records")
}

/// *
///  * Player-specific settings and preferences
///  * Granular control over privacy, notifications, and display
model PlayerSettings {
  id                 String   @id @default(cuid())
  playerId           String   @unique @map("player_id")
  tenantId           String   @map("tenant_id")
  isProfilePublic    Boolean  @default(true) @map("is_profile_public")
  showStatistics     Boolean  @default(true) @map("show_statistics")
  showAchievements   Boolean  @default(true) @map("show_achievements")
  showHistory        Boolean  @default(true) @map("show_history")
  emailNotifications Json     @default("{}") @map("email_notifications")
  pushNotifications  Json     @default("{}") @map("push_notifications")
  smsNotifications   Json     @default("{}") @map("sms_notifications")
  theme              String   @default("LIGHT") @db.VarChar(20)
  language           String   @default("en") @db.VarChar(10)
  timezone           String?  @db.VarChar(100)
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, playerId])
  @@index([tenantId])
  @@map("player_settings")
}
