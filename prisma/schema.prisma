// Tournament Platform - Prisma Schema
// Multi-tenant architecture with Row-Level Security (RLS)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ORGANIZATIONS (Multi-Tenant)
// ============================================================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  members     OrganizationMember[]
  tournaments Tournament[]

  @@map("organizations")
}

model OrganizationMember {
  id     String @id @default(cuid())
  orgId  String @map("org_id")
  userId String @map("user_id")
  role   String // owner, td, scorekeeper, streamer

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, userId])
  @@index([orgId])
  @@index([userId])
  @@map("organization_members")
}

// ============================================================================
// TOURNAMENTS
// ============================================================================

model Tournament {
  id                  String   @id @default(cuid())
  orgId               String   @map("org_id") // Tenant ID
  name                String
  status              String // draft, registration, active, paused, completed, cancelled
  format              String // single_elimination, double_elimination, round_robin, modified_single, chip_format
  sportConfigId       String   @map("sport_config_id")
  sportConfigVersion  String   @map("sport_config_version") // Frozen at creation
  createdBy           String   @map("created_by")
  createdAt           DateTime @default(now()) @map("created_at")
  startedAt           DateTime? @map("started_at")
  completedAt         DateTime? @map("completed_at")

  // Relations
  organization   Organization      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  players        Player[]
  matches        Match[]
  tables         Table[]
  events         TournamentEvent[]

  @@index([orgId])
  @@index([status])
  @@index([createdAt])
  @@map("tournaments")
}

// ============================================================================
// EVENT-SOURCED AUDIT LOG (Append-Only)
// ============================================================================

model TournamentEvent {
  id           String   @id @default(cuid())
  tournamentId String   @map("tournament_id")
  kind         String // event type (tournament.created, player.registered, etc.)
  actor        String // User ID who performed the action
  device       String // Device ID for CRDT sync
  payload      Json // Event-specific data
  timestamp    DateTime @default(now())

  // Relations
  tournament Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)

  @@index([tournamentId])
  @@index([timestamp])
  @@index([kind])
  @@map("tournament_events")
}

// ============================================================================
// PLAYERS
// ============================================================================

model Player {
  id           String   @id @default(cuid())
  tournamentId String   @map("tournament_id")
  name         String
  email        String?
  phone        String?
  rating       Json? // { system: "apa" | "fargo" | "bca", value: number | string }
  status       String // registered, checked_in, active, eliminated, no_show, withdrawn
  seed         Int?
  checkedInAt  DateTime? @map("checked_in_at")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  tournament       Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  matchesAsPlayerA Match[]    @relation("PlayerA")
  matchesAsPlayerB Match[]    @relation("PlayerB")

  @@index([tournamentId])
  @@index([status])
  @@map("players")
}

// ============================================================================
// MATCHES
// ============================================================================

model Match {
  id           String   @id @default(cuid())
  tournamentId String   @map("tournament_id")
  round        Int
  bracket      String? // winners, losers (null for non-bracket formats)
  position     Int // Position in bracket/round
  playerAId    String?  @map("player_a_id")
  playerBId    String?  @map("player_b_id")
  state        String // pending, ready, assigned, active, completed, cancelled
  winnerId     String?  @map("winner_id")
  score        Json // { playerA: number, playerB: number, raceTo?: number, games?: GameScore[] }
  tableId      String?  @map("table_id")
  startedAt    DateTime? @map("started_at")
  completedAt  DateTime? @map("completed_at")
  rev          Int      @default(0) // Optimistic locking

  // Relations
  tournament Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  playerA    Player?    @relation("PlayerA", fields: [playerAId], references: [id])
  playerB    Player?    @relation("PlayerB", fields: [playerBId], references: [id])
  table      Table?     @relation(fields: [tableId], references: [id])

  @@index([tournamentId])
  @@index([state])
  @@index([tableId])
  @@index([round])
  @@map("matches")
}

// ============================================================================
// TABLES
// ============================================================================

model Table {
  id             String   @id @default(cuid())
  tournamentId   String   @map("tournament_id")
  label          String // e.g., "Table 1", "Back Corner"
  status         String // available, in_use, blocked
  blockedUntil   DateTime? @map("blocked_until")
  currentMatchId String?  @map("current_match_id")

  // Relations
  tournament Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  matches    Match[]

  @@index([tournamentId])
  @@index([status])
  @@map("tables")
}

// ============================================================================
// SPORT CONFIGURATIONS (Versioned, Frozen per Tournament)
// ============================================================================

model SportConfig {
  id               String   @id @default(cuid())
  name             String // e.g., "Pool 8-Ball", "Pool 9-Ball"
  sport            String // pool, darts, cornhole (future)
  rules            Json // Sport-specific rules
  scoringSchema    Json     @map("scoring_schema")
  bracketTemplates Json     @map("bracket_templates")
  version          String // Semantic version
  createdAt        DateTime @default(now()) @map("created_at")

  @@unique([name, version])
  @@index([sport])
  @@map("sport_configs")
}
