name: Backend Worker
on:
  pull_request:
    paths:
      - "apps/sync-service/**"
      - "packages/crdt/**"
      - "packages/events/**"
      - "packages/pubsub/**"
      - "prisma/**"
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  security-events: write

concurrency:
  group: backend-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: build
    if: contains(github.event.pull_request.labels.*.name, 'lane:backend')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - uses: actions/cache@v3
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build

      - name: Build sync-service
        run: pnpm --filter sync-service build

  test:
    name: test
    if: contains(github.event.pull_request.labels.*.name, 'lane:backend')
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Prisma migrations
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test
        run: |
          pnpm prisma migrate deploy
          pnpm prisma generate

      - name: Run unit tests
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test
          REDIS_URL: redis://localhost:6379
        run: |
          pnpm --filter sync-service test
          pnpm --filter crdt test
          pnpm --filter events test

      - name: Check coverage
        run: |
          # Ensure coverage is at least 80%
          COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct' 2>/dev/null || echo "0")

          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "âš ï¸ Coverage is below 80% ($COVERAGE%)"
            echo "Please add more tests"
            exit 1
          fi

          echo "âœ… Coverage: $COVERAGE%"

      - name: Tenant isolation validation
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test
        run: |
          echo "ðŸ” Validating tenant isolation..."

          # Check for queries without tenant_id
          UNSAFE_QUERIES=$(grep -r "findMany\|findFirst" apps/sync-service packages/crdt | grep -v "tenant_id" | grep -v "node_modules" | wc -l || echo "0")

          if [ "$UNSAFE_QUERIES" -gt 0 ]; then
            echo "âš ï¸ Warning: Found $UNSAFE_QUERIES potentially unsafe queries"
            echo "Please ensure all queries include tenant_id scoping"
            grep -r "findMany\|findFirst" apps/sync-service packages/crdt | grep -v "tenant_id" | grep -v "node_modules" || true
          else
            echo "âœ… Tenant isolation checks passed"
          fi

  lint:
    name: lint
    if: contains(github.event.pull_request.labels.*.name, 'lane:backend')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm lint

      - name: Run TypeScript check
        run: pnpm typecheck

  security-scan:
    name: security-scan
    if: contains(github.event.pull_request.labels.*.name, 'lane:backend')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run OSV Scanner
        uses: google/osv-scanner-action@v1
        with:
          scan-args: |-
            --lockfile=pnpm-lock.yaml

      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for hardcoded secrets
        run: |
          echo "ðŸ” Checking for hardcoded secrets..."

          # Check for common secret patterns
          SECRETS_FOUND=0

          # API keys
          if grep -r "api[_-]key.*=.*['\"][a-zA-Z0-9]" apps/sync-service packages/ --exclude-dir=node_modules | grep -v "\.test\." | grep -v "\.spec\."; then
            echo "âš ï¸ Found potential hardcoded API keys"
            SECRETS_FOUND=1
          fi

          # Database URLs
          if grep -r "DATABASE_URL.*=.*postgresql://" apps/ packages/ --exclude-dir=node_modules | grep -v "\.test\." | grep -v "\.example"; then
            echo "âš ï¸ Found potential hardcoded database URLs"
            SECRETS_FOUND=1
          fi

          if [ $SECRETS_FOUND -eq 1 ]; then
            echo "âŒ Security scan failed - secrets detected"
            exit 1
          fi

          echo "âœ… No hardcoded secrets found"

      - name: Label PR if security issues
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr edit ${{ github.event.pull_request.number }} --add-label "security-alert"

          gh pr comment ${{ github.event.pull_request.number }} --body "## ðŸš¨ Security Issues Detected

          This PR has security concerns that must be addressed:

          - Check the security-scan job for details
          - Remove any hardcoded secrets
          - Fix dependency vulnerabilities

          **Human security review required before merge.**"

  update-status:
    name: update-status
    if: always() && contains(github.event.pull_request.labels.*.name, 'lane:backend')
    needs: [build, test, lint, security-scan]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Update agent status
        run: |
          AGENT_ID="backend-${{ github.event.pull_request.number }}"
          STATUS_FILE="agent-status/${AGENT_ID}.json"

          mkdir -p agent-status

          # Determine overall status
          if [ "${{ needs.build.result }}" = "success" ] && [ "${{ needs.test.result }}" = "success" ] && [ "${{ needs.lint.result }}" = "success" ] && [ "${{ needs.security-scan.result }}" = "success" ]; then
            STATUS="success"
          else
            STATUS="failed"
          fi

          cat > "$STATUS_FILE" <<EOF
          {
            "agentId": "${AGENT_ID}",
            "type": "worker",
            "lane": "backend",
            "status": "${STATUS}",
            "task": "Backend implementation",
            "pr": "#${{ github.event.pull_request.number }}",
            "branch": "${{ github.head_ref }}",
            "lastUpdate": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "build": "${{ needs.build.result }}",
            "test": "${{ needs.test.result }}",
            "lint": "${{ needs.lint.result }}",
            "security": "${{ needs.security-scan.result }}"
          }
          EOF

      - name: Track cost
        run: |
          node scripts/track-costs.js track "backend-${{ github.event.pull_request.number }}" "backend" "haiku" "moderate"